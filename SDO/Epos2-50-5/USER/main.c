
/******************** (C) COPYRIGHT 2019 HOME Team **************************
 * 描述    ：通过单片机CAN总线，发送数据给控制器，实现多个电机的控制      
 * 实验平台：STM32F103最小系统+CAN接收器+TTL转USB+EPOS2 50/5控制器+maxon DC电机
 * 库版本  ：ST3.5.0
*****************************************************************************/

#include "stm32f10x.h"
#include "usart1.h"
#include "can.h"
#include "epos.h"
#include "delay.h"
#include "timer.h"

#define PI 3.1415

__IO uint32_t flag = 0xff;          //用于标志是否接收到数据，在中断函数中赋值

CanTxMsg TxMessage;                     //发送缓冲区
CanRxMsg RxMessage;                         //接收缓冲区

Uint32 pos=0;                                       //电机位置
int x=0;                                                //角度自变量
int angle_sensor;

double ang[51]  = {6.464,7.102,8.449,10.158,11.772,12.992,13.599,13.527,12.995,12.22,11.283,10.256,9.193,8.152,7.174,6.271,5.442,4.702,4.079,3.597,3.299,3.222,
    3.418,3.947,4.855,6.2,8.084,10.621,13.945,18.181,23.361,29.341,35.748,42.002,47.489,51.734,54.476,55.651,55.3,53.502,50.384,46.118,40.922,35.037,28.801,22.629,
16.957,12.215,8.741,6.708,6.017};

int angle_0[57] = {0, 30, 90, 180, 300, 450, 630, 840, 1080, 1350, 1650, 1980, 2310, 2640, 2970, 3270, 3540, 3780, 3990, 4170, 4290, 4380, 4440, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4463, 4443, 4423, 4403, 4383, 4333, 4223, 4013, 3703, 3293, 2783, 2173, 1463, 653, -257};
int angle_1[102] = {-1217 , -2177 , -3136 , -4096 , -5055 , -6015 , -6974 , -7934 , -8893 , -9853 , -10812 , -11772 , -12731 , -13691 , -14650 , -15610 , -16569 , -17529 , 
	-18439 , -19249 , -19959 , -20569 , -21079 , -21489 , -21799 , -22009 , -22119 , -22129 , -22039 , -21849 , -21559 , -21169 , -20679 , -20089 , -19399 , -18609 , -17719 , -16729 , -15639 , -14449 , -13159 , -11769 , -10279 , -8739 , -7199 , -5709 , -4319 , -3029 , -1839 , -749 , 241 , 
	1217 , 2177 , 3136 , 4096 , 5055 , 6015 , 6974 , 7934 , 8893 , 9853 , 10812 , 11772 , 12731 , 13691 , 14650 , 15610 , 16569 , 17529 , 
	18439 , 19249 , 19959 , 20569 , 21079 , 21489 , 21799 , 22009 , 22119 , 22129 , 22039 , 21849 , 21559 , 21169 , 20679 , 20089 , 19399 , 18609 , 17719 , 16729 , 15639 , 14449 , 13159 , 11769 , 10279 , 8739 , 7199 , 5709 , 4319 , 3029 , 1839 , 749 , -241};

int knee_0[29] = {0, -40, -80, -120, -160, -200, -240, -280, -320, -360, -400, -440, -480, -520, -560, -600, -640, -680, -765, -896, -1078, -1311, -1595, -1930, -2316, -2753, -3190, -3627, -4064};
int knee_1[102] = {-4501, -4938, -5376, -5813, -6250, -6687, -7124, -7561, -7999, -8436, -8873, -9310, -9747, -10185, -10622, -11059, -11496, -11933, -12371, -12808, -13245, -13682, -14119, -14556, -14994, -15431, 
	-15738, -15915, -15962, -15879, -15666, -15323, -14850, -14247, -13514, -12651, -11658, -10535, -9282, -7899, -6386, -4833, -3330, -1957, -714, 399, 1382, 2235, 2958, 3551, 4064, 
	4501, 4938, 5376, 5813, 6250, 6687, 7124, 7561, 7999, 8436, 8873, 9310, 9747, 10185, 10622, 11059, 11496, 11933, 12371, 12808, 13245, 13682, 14119, 14556, 14994, 15431, 
	15738, 15915, 15962, 15879, 15666, 15323, 14850, 14247, 13514, 12651, 11658, 10535, 9282, 7899, 6386, 4833, 3330, 1957, 714, -399, -1382, -2235, -2958, -3551, -4064};
	
	
int test_angle[71] = {1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,
	1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,
					500,0,-500,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,
					-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-1000,-500,0,500};



int hip_0_5m[114] = {0, 15, 30, 60, 90, 135, 180, 240, 300, 375, 450, 540, 630, 735, 840, 960, 1080, 1215, 1350, 1500, 1650, 1815, 1980, 2145, 2310, 2475, 2640, 2805, 2970, 3120, 3270, 3405, 3540, 3660, 3780, 3885, 3990, 4080, 4170, 4230, 4290, 4335, 4380, 4410, 4440, 4455, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4466.5, 4463, 4453, 4443, 4433, 4423, 4413, 4403, 4393, 4383, 4358, 4333, 4278, 4223, 4118, 4013, 3858, 3703, 3498, 3293, 3038, 2783, 2478, 2173, 1818, 1463, 1058, 653, 198, -257, -737};
int hip_1_5m[204] = {-1217, -1697, -2177, -2656.5, -3136, -3616, -4096, -4575.5, -5055, -5535, -6015, -6494.5, -6974, -7454, -7934, -8413.5, -8893, -9373, -9853, -10332.5, -10812, -11292, -11772, -12251.5, -12731, -13211, -13691, -14170.5, -14650, -15130, -15610, -16089.5, -16569, -17049, -17529, -17984, -18439, -18844, -19249, -19604, -19959, -20264, -20569, -20824, -21079, -21284, -21489, -21644, -21799, -21904, -22009, -22064, -22119, -22124, -22129, -22084, -22039, -21944, -21849, -21704, -21559, -21364, -21169, -20924, -20679, -20384, -20089, -19744, -19399, -19004, -18609, -18164, -17719, -17224, -16729, -16184, -15639, -15044, -14449, -13804, -13159, -12464, -11769, -11024, -10279, -9509, -8739, -7969, -7199, -6454, -5709, -5014, -4319, -3674, -3029, -2434, -1839, -1294, -749, -254, 241, 729, 1217, 1697, 2177, 2656.5, 3136, 3616, 4096, 4575.5, 5055, 5535, 6015, 6494.5, 6974, 7454, 7934, 8413.5, 8893, 9373, 9853, 10332.5, 10812, 11292, 11772, 12251.5, 12731, 13211, 13691, 14170.5, 14650, 15130, 15610, 16089.5, 16569, 17049, 17529, 17984, 18439, 18844, 19249, 19604, 19959, 20264, 20569, 20824, 21079, 21284, 21489, 21644, 21799, 21904, 22009, 22064, 22119, 22124, 22129, 22084, 22039, 21944, 21849, 21704, 21559, 21364, 21169, 20924, 20679, 20384, 20089, 19744, 19399, 19004, 18609, 18164, 17719, 17224, 16729, 16184, 15639, 15044, 14449, 13804, 13159, 12464, 11769, 11024, 10279, 9509, 8739, 7969, 7199, 6454, 5709, 5014, 4319, 3674, 3029, 2434, 1839, 1294, 749, 254, -241, -729};

int hip_0_10m[57] = {0, 30, 90, 180, 300, 450, 630, 840, 1080, 1350, 1650, 1980, 2310, 2640, 2970, 3270, 3540, 3780, 3990, 4170, 4290, 4380, 4440, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4470, 4463, 4443, 4423, 4403, 4383, 4333, 4223, 4013, 3703, 3293, 2783, 2173, 1463, 653, -257};
int hip_1_10m[102] = {-1217 , -2177 , -3136 , -4096 , -5055 , -6015 , -6974 , -7934 , -8893 , -9853 , -10812 , -11772 , -12731 , -13691 , -14650 , -15610 , -16569 , -17529 , -18439 , -19249 , -19959 , -20569 , -21079 , -21489 , -21799 , -22009 , -22119 , -22129 , -22039 , -21849 , -21559 , -21169 , -20679 , -20089 , -19399 , -18609 , -17719 , -16729 , -15639 , -14449 , -13159 , -11769 , -10279 , -8739 , -7199 , -5709 , -4319 , -3029 , -1839 , -749 , 241 , 1217 , 2177 , 3136 , 4096 , 5055 , 6015 , 6974 , 7934 , 8893 , 9853 , 10812 , 11772 , 12731 , 13691 , 14650 , 15610 , 16569 , 17529 , 18439 , 19249 , 19959 , 20569 , 21079 , 21489 , 21799 , 22009 , 22119 , 22129 , 22039 , 21849 , 21559 , 21169 , 20679 , 20089 , 19399 , 18609 , 17719 , 16729 , 15639 , 14449 , 13159 , 11769 , 10279 , 8739 , 7199 , 5709 , 4319 , 3029 , 1839 , 749 , -241};

int hip_0_15m[38] = {30 , 135 , 300 , 540 , 840 , 1215 , 1650 , 2145 , 2640 , 3120 , 3540 , 3885 , 4170 , 4335 , 4440 , 4470 , 4470 , 4470 , 4470 , 4470 , 4470 , 4470 , 4470 , 4470 , 4470 , 4470 , 4470 , 4467 , 4443 , 4413 , 4383 , 4278 , 4013 , 3498 , 2783 , 1818 , 653 , -737};
int hip_1_15m[68] = {-2177 , -3616 , -5055 , -6495 , -7934 , -9373 , -10812 , -12252 , -13691 , -15130 , -16569 , -17984 , -19249 , -20264 , -21079 , -21644 , -22009 , -22124 , -22039 , -21704 , -21169 , -20384 , -19399 , -18164 , -16729 , -15044 , -13159 , -11024 , -8739 , -6454 , -4319 , -2434 , -749 , 729 , 2177 , 3616 , 5055 , 6495 , 7934 , 9373 , 10812 , 12252 , 13691 , 15130 , 16569 , 17984 , 19249 , 20264 , 21079 , 21644 , 22009 , 22124 , 22039 , 21704 , 21169 , 20384 , 19399 , 18164 , 16729 , 15044 , 13159 , 11024 , 8739 , 6454 , 4319 , 2434 , 749 , -729};


//---------------*/*|*\*——*/*|*\*——*/---------------*/*|*\*——*/*|*\*——*/---------------*/*|*\*——*/*|*\*——*/---------------*/*|*\*——*/*|*\*——*/------------------


int knee_0_5m[58] = {0 , -20 , -40 , -60 , -80 , -100 , -120 , -140 , -160 , -180 , -200 , -220 , -240 , -260 , -280 , -300 , -320 , -340 , -360 , -380 , -400 , -420 , -440 , -460 , -480 , -500 , -520 , -540 , -560 , -580 , -600 , -620 , -640 , -660 , -680 , -723 , -765 , -831 , -896 , -987 , -1078 , -1195 , -1311 , -1453 , -1595 , -1763 , -1930 , -2123 , -2316 , -2535 , -2753 , -2972 , -3190 , -3409 , -3627 , -3846 , -4064 , -4283};
int knee_1_5m[204] = {-4501 , -4720 , -4938 , -5157 , -5376 , -5595 , -5813 , -6032 , -6250 , -6469 , -6687 , -6906 , -7124 , -7343 , -7561 , -7780 , -7999 , -8218 , -8436 , -8655 , -8873 , -9092 , -9310 , -9529 , -9747 , -9966 , -10185 , -10404 , -10622 , -10841 , -11059 , -11278 , -11496 , -11715 , -11933 , -12152 , -12371 , -12590 , -12808 , -13027 , -13245 , -13464 , -13682 , -13901 , -14119 , -14338 , -14556 , -14775 , -14994 , -15213 , -15431 , -15585 , -15738 , -15827 , -15915 , -15939 , -15962 , -15921 , -15879 , -15773 , -15666 , -15495 , -15323 , -15087 , -14850 , -14549 , -14247 , -13881 , -13514 , -13083 , -12651 , -12155 , -11658 , -11097 , -10535 , -9909 , -9282 , -8591 , -7899 , -7143 , -6386 , -5610 , -4833 , -4082 , -3330 , -2644 , -1957 , -1336 , -714 , -158 , 399 , 891 , 1382 , 1809 , 2235 , 2597 , 2958 , 3255 , 3551 , 3808 , 4064 , 4283 , 4501 , 4720 , 4938 , 5157 , 5376 , 5595 , 5813 , 6032 , 6250 , 6469 , 6687 , 6906 , 7124 , 7343 , 7561 , 7780 , 7999 , 8218 , 8436 , 8655 , 8873 , 9092 , 9310 , 9529 , 9747 , 9966 , 10185 , 10404 , 10622 , 10841 , 11059 , 11278 , 11496 , 11715 , 11933 , 12152 , 12371 , 12590 , 12808 , 13027 , 13245 , 13464 , 13682 , 13901 , 14119 , 14338 , 14556 , 14775 , 14994 , 15213 , 15431 , 15585 , 15738 , 15827 , 15915 , 15939 , 15962 , 15921 , 15879 , 15773 , 15666 , 15495 , 15323 , 15087 , 14850 , 14549 , 14247 , 13881 , 13514 , 13083 , 12651 , 12155 , 11658 , 11097 , 10535 , 9909 , 9282 , 8591 , 7899 , 7143 , 6386 , 5610 , 4833 , 4082 , 3330 , 2644 , 1957 , 1336 , 714 , 158 , -399 , -891 , -1382 , -1809 , -2235 , -2597 , -2958 , -3255 , -3551 , -3808 , -4064 , -4283};

int knee_0_10m[29] = {0, -40, -80, -120, -160, -200, -240, -280, -320, -360, -400, -440, -480, -520, -560, -600, -640, -680, -765, -896, -1078, -1311, -1595, -1930, -2316, -2753, -3190, -3627, -4064};
int knee_1_10m[102] = {-4501, -4938, -5376, -5813, -6250, -6687, -7124, -7561, -7999, -8436, -8873, -9310, -9747, -10185, -10622, -11059, -11496, -11933, -12371, -12808, -13245, -13682, -14119, -14556, -14994, -15431, -15738, -15915, -15962, -15879, -15666, -15323, -14850, -14247, -13514, -12651, -11658, -10535, -9282, -7899, -6386, -4833, -3330, -1957, -714, 399, 1382, 2235, 2958, 3551, 4064, 4501, 4938, 5376, 5813, 6250, 6687, 7124, 7561, 7999, 8436, 8873, 9310, 9747, 10185, 10622, 11059, 11496, 11933, 12371, 12808, 13245, 13682, 14119, 14556, 14994, 15431, 15738, 15915, 15962, 15879, 15666, 15323, 14850, 14247, 13514, 12651, 11658, 10535, 9282, 7899, 6386, 4833, 3330, 1957, 714, -399, -1382, -2235, -2958, -3551, -4064};

int knee_0_15m[19] = {-60 , -120 , -180 , -240 , -300 , -360 , -420 , -480 , -540 , -600 , -660 , -765 , -987 , -1311 , -1763 , -2316 , -2972 , -3627 , -4283};
int knee_1_15m[68] = {-4938 , -5595 , -6250 , -6906 , -7561 , -8218 , -8873 , -9529 , -10185 , -10841 , -11496 , -12152 , -12808 , -13464 , -14119 , -14775 , -15431 , -15827 , -15962 , -15773 , -15323 , -14549 , -13514 , -12155 , -10535 , -8591 , -6386 , -4082 , -1957 , -158 , 1382 , 2597 , 3551 , 4283 , 4938 , 5595 , 6250 , 6906 , 7561 , 8218 , 8873 , 9529 , 10185 , 10841 , 11496 , 12152 , 12808 , 13464 , 14119 , 14775 , 15431 , 15827 , 15962 , 15773 , 15323 , 14549 , 13514 , 12155 , 10535 , 8591 , 6386 , 4082 , 1957 , 158 , -1382 , -2597 , -3551 , -4283};


Uint8 NODE_ID2 = 2;                          //EPOS的节点ID
Uint8 NODE_ID1 = 1;

Epos Controller2,Controller1;        //控制器对象

// 描述  : "主机"的主函数 
int main(void){

    SysTick_Init();                             //延迟中断定时器
    
    USART1_Config();                            //初始化串口模块
    
    TIME_NVIC_Configuration();
    TIME2_Configuration();
    
    CAN_Config();                               //配置CAN模块   
    
    printf("board init complete!\r\n");
    Epos_Delay(500);    
    
	Epos_Init(&Controller2,  NOT_USED, NODE_ID2);      //初始化最大加速度，速度，跟踪误差，波特率1M/s，
	Epos_Init(&Controller1, NOT_USED, NODE_ID1);
	
    printf("\r\ninitial EPOS done!\r\n\r\n");
    
    Epos_Delay(500);    
    
    //******** 模式设置 *******
    Epos_setMode(&Controller2, Position_Mode);
    Epos_setMode(&Controller1,Position_Mode);
    
    Epos_Delay(500);    
    //SDO_Read(&Controller2,OD_STATUS_WORD,0x00);            //Switched On    Status=0x0140 绿灯闪烁
    //printf("\r\n%X\r\n",SDO_Read(&Controller2,OD_STATUS_WORD,0x00));
    printf("\r\nstatus\r\n");
    
    //******** 使能EPOS *******
    Epos_OperEn(&Controller2);                                               //Switch On Disable to Operation Enable
    Epos_OperEn(&Controller1);

    printf("\r\nenable EPOS\r\n\r\n");
    
    
    //******** EPOS复零位 *******
    SDO_Write(&Controller2, PM_SET_VALUE,0x00,0); //home position, 设为0
    SDO_Write(&Controller1,PM_SET_VALUE,0x00,0);
    
    printf("\r\nEPOS set 0 \r\n\r\n");
    /*
	SDO_Write(&Controller2, PM_SET_VALUE,0x00,10682); //home position, 设为0
    SDO_Write(&Controller1,PM_SET_VALUE,0x00,10682);
	*/
    
	Epos_Delay(2000); 
    
    
    //******** Read Angels *******
    printf("\r\nEPOS control beginning!\r\n\r\n");

    /*NMT_Pre(&Controller2, ALL);                        
	SDO_Read(&Controller2,OD_STATUS_WORD,0x00);            

    PDO_Config(&Controller2);
    SDO_Read(&Controller2,0x1400,0x01);
    SDO_Read(&Controller2,0x1600,0x00);
    SDO_Read(&Controller2,0x1600,0x01);

    NMT_Start(&Controller2, ALL);
    SDO_Read(&Controller2,OD_STATUS_WORD,0x00);          //第九位为1   Status=0x0337 绿灯常量*/
    

    //SDO_Write(&Controller2, 0x206B, 0x00, 500);
    //SDO_Write(&Controller1, 0x206B, 0x00, 1000);
    
    
    /*while(1){
        
        //pos = 30000*sin(PI*x/50);                     //从0-30000变化  发送太快，数据间隔太大，电机抖动
        pos = (x>=323)? angle_2[x-323]:angle_1[x];
        //PDO_Write(201, pos);
        
        angle_sensor = SDO_Read(&Controller2,Pos_Demand_Value,0x00);
        
        PM_SetAngle(&Controller2, pos);
        PM_SetAngle(&Controller1,pos);
        
        
        Epos_Delay(7);                                                      //delay 10ms
        printf("%d\t%d\r\n",x,angle_sensor);
        if( ++x==727 ){x = 0;}
    }*/
    
    TIM_ITConfig(TIM2,TIM_IT_Update|TIM_IT_Trigger,ENABLE);
    
    while(1){
        if(flag == 0){
            flag = 0xff;
            //printf("o\r\n");
        }
    }
}
